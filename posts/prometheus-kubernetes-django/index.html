<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#FFFFFF"><title>Using Prometheus for monitoring Django applications in Kubernetes &#183; Marc Tudurí</title>
<meta name=title content="Using Prometheus for monitoring Django applications in Kubernetes &#183; Marc Tudurí"><script type=text/javascript src=/js/appearance.min.8a082f81b27f3cb2ee528df0b0bdc39787034cf2cc34d4669fbc9977c929023c.js integrity="sha256-iggvgbJ/PLLuUo3wsL3Dl4cDTPLMNNRmn7yZd8kpAjw="></script><link type=text/css rel=stylesheet href=/css/main.bundle.min.b0785c8131a75f72b211435af86269eb2d4b81dda03a8f2cf5ccb1c967747167.css integrity="sha256-sHhcgTGnX3KyEUNa+GJp6y1Lgd2gOo8s9cyxyWd0cWc="><meta name=description content="
      Using Prometheus for monitoring Django applications in Kubernetes
    "><link rel=canonical href=https://marctuduri.com/posts/prometheus-kubernetes-django/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://marctuduri.com/posts/prometheus-kubernetes-django/"><meta property="og:site_name" content="Marc Tudurí"><meta property="og:title" content="Using Prometheus for monitoring Django applications in Kubernetes"><meta property="og:description" content="Using Prometheus for monitoring Django applications in Kubernetes"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-08T00:00:00+00:00"><meta property="article:modified_time" content="2018-10-08T00:00:00+00:00"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Monitoring"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Prometheus for monitoring Django applications in Kubernetes"><meta name=twitter:description content="Using Prometheus for monitoring Django applications in Kubernetes"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","articleSection":"","name":"Using Prometheus for monitoring Django applications in Kubernetes","headline":"Using Prometheus for monitoring Django applications in Kubernetes","description":"Using Prometheus for monitoring Django applications in Kubernetes","abstract":"\u003ch3 id=\u0022django-application-deployment-architecture\u0022 class=\u0022relative group\u0022\u003eDjango application deployment architecture \u003cspan class=\u0022absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100\u0022\u003e\u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022 style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#django-application-deployment-architecture\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\u003c\/span\u003e\u003c\/h3\u003e\u003cp\u003eDeveloping web applications with \u003ca href=\u0022https:\/\/www.djangoproject.com\/\u0022 target=\u0022_blank\u0022 rel=\u0022noreferrer\u0022\u003eDjango\u003c\/a\u003e is very easy and fun: if you just follow the \u003ca href=\u0022https:\/\/docs.djangoproject.com\/en\/2.1\/intro\/tutorial01\/\u0022 target=\u0022_blank\u0022 rel=\u0022noreferrer\u0022\u003etutorial\u003c\/a\u003e in a few hours you can have up and running your own website. However, deploying a Django site can be hard and you can end up running a site with a terrible performance if you don\u0026rsquo;t follow the recommended guidelines to deploy a Django site to a production environment.\u003c\/p\u003e","inLanguage":"en","url":"https:\/\/marctuduri.com\/posts\/prometheus-kubernetes-django\/","author":{"@type":"Person","name":"Marc Tudurí"},"copyrightYear":"2018","dateCreated":"2018-10-08T00:00:00\u002b00:00","datePublished":"2018-10-08T00:00:00\u002b00:00","dateModified":"2018-10-08T00:00:00\u002b00:00","keywords":["prometheus","kubernetes","monitoring"],"mainEntityOfPage":"true","wordCount":"2089"}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://marctuduri.com/","name":"Home","position":1},{"@type":"ListItem","item":"https://marctuduri.com/posts/","name":"","position":2},{"@type":"ListItem","name":"Using Prometheus for Monitoring Django Applications in Kubernetes","position":3}]}</script><meta name=author content="Marc Tudurí"></head><body class="m-auto flex h-screen max-w-7xl flex-col bg-neutral px-6 text-lg leading-7 text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="-translate-y-8 rounded-b-lg bg-primary-200 px-3 py-1 text-sm focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="pe-2 font-bold text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold text-neutral-900 dark:text-neutral sm:py-10 print:hidden"><nav class="flex items-start justify-between sm:items-center"><div class="flex flex-row items-center"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>Marc Tudurí</a></div><ul class="flex list-none flex-col text-end sm:flex-row"><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/posts/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Blog</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=/talks/ title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2">Talks</span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=https://github.com/marctc title target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a></li><li class="group mb-1 sm:mb-0 sm:me-7 sm:last:me-0.5"><a href=https://hachyderm.io/@marctc title target=_blank><span class="group-dark:hover:text-primary-400 transition-colors group-hover:text-primary-600"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 448 512"><path fill="currentcolor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></span></span></a></li></ul></nav></header><div class="relative flex grow flex-col"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mb-8 mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Using Prometheus for monitoring Django applications in Kubernetes</h1><div class="mb-10 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-10-08 00:00:00 +0000 UTC">8 October 2018</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">10 mins</span></div></div></header><section class="prose mt-0 flex max-w-full flex-col dark:prose-invert lg:flex-row"><div class="min-h-0 min-w-0 max-w-prose grow"><h3 id=django-application-deployment-architecture class="relative group">Django application deployment architecture <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#django-application-deployment-architecture aria-label=Anchor>#</a></span></h3><p>Developing web applications with <a href=https://www.djangoproject.com/ target=_blank rel=noreferrer>Django</a> is very easy and fun: if you just follow the <a href=https://docs.djangoproject.com/en/2.1/intro/tutorial01/ target=_blank rel=noreferrer>tutorial</a> in a few hours you can have up and running your own website. However, deploying a Django site can be hard and you can end up running a site with a terrible performance if you don&rsquo;t follow the recommended guidelines to deploy a Django site to a production environment.</p><p>There are many options to deploy a Django application but you will finish using a <a href=http://wsgi.org/ target=_blank rel=noreferrer>WSGI</a> (Web Server Gateway Interface) which is a Python specification that describes how a webserver communicates with web applications. One of the most popular and most used WSGI implementations is <a href=https://uwsgi-docs.readthedocs.io/en/latest/ target=_blank rel=noreferrer>uWSGI</a> and it is the <a href=https://docs.djangoproject.com/en/2.1/howto/deployment/wsgi/ target=_blank rel=noreferrer>recommended way</a> to deploy a Django application by the Django site.</p><p>Another key element to deploy a Django application is to use a reverse proxy in front of the WSGI application which provides a better way to route the inbound traffic to the site, serve static files, TLS termination and increase the traffic performance. We will end up with a schema like this:</p><pre tabindex=0><code>the web client &lt;-&gt; the web server &lt;-&gt; the socket &lt;-&gt; uWSGI &lt;-&gt; Python
</code></pre><p>A common approach is to use <a href=https://nginx.org/ target=_blank rel=noreferrer>NGINX</a> as a reverse proxy. <a href=https://uwsgi-docs.readthedocs.io/en/latest/tutorials/Django_and_nginx.html target=_blank rel=noreferrer>This tutorial</a> explains with a very good level of detail how to set up a Django application with uWSGI and NGINX.</p><p>There are a lot of approaches to deploying Django applications in a cloud environment using Docker. As we deploy many of our applications in <a href=https://kubernetes.io target=_blank rel=noreferrer>Kubernetes</a> we developed a <a href=http://helm.sh target=_blank rel=noreferrer>Helm</a> chart in order to automatize the deployment of new sites. You can take a look at these charts <a href=https://github.com/APSL/kubernetes-charts target=_blank rel=noreferrer>here</a>.</p><h3 id=monitoring-architecture class="relative group">Monitoring architecture <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#monitoring-architecture aria-label=Anchor>#</a></span></h3><p>Once we have our Django application architecture for live environments it is strongly suggested to add a monitor system to our production infrastructure. Our idea is to have an <a href=https://medium.com/@copyconstruct/monitoring-and-observability-8417d1952e1c target=_blank rel=noreferrer>observable</a> system, so to achieve that, we need to get metrics of <strong>each</strong> piece of the Django application architecture: uWSGI, NGINX and Django server. There are many options for collecting metrics: Graphite, InfluxDB, StatsD but for our architecture, we will choose Prometheus as a monitoring system.</p><p><a href=https://prometheus.io/ target=_blank rel=noreferrer>Prometheus</a> works as pull model (in contrast of InfluxDB, which is push model) which means that the metrics are collected periodically from an HTTP endpoint and sent to a time series database. Pull model works very well for online-serving systems, i.e a website, because you don&rsquo;t need to know if metrics are properly sent to the metric storage: you decouple the delivery of metrics from the main application winning in simplicity and performance. However, this work for our uses cases so probably sometimes you should need to use a push model and send the metrics explicitly. For that purpose, you can use InfluxDB (<a href=https://www.influxdata.com/time-series-platform/ target=_blank rel=noreferrer>TICK Stack</a>) as mentioned before or keep using Prometheus with the <a href=https://prometheus.io/docs/practices/pushing/ target=_blank rel=noreferrer>Pushgateway</a> module.</p><p>On the other hand, a great advantage of Prometheus is the existence of <a href=https://prometheus.io/docs/instrumenting/exporters/ target=_blank rel=noreferrer>Prometheus exporters</a>. Many of open source software projects include natively its support for exposing metrics in Prometheus format. If a software or library doesn&rsquo;t have it, you will need an exporter which can be attached as a running process to any software that doesn&rsquo;t export Prometheus metrics by default. This will expose all the metrics on HTTP endpoint (typically <code>/metrics</code>) at a <a href=https://github.com/prometheus/prometheus/wiki/Default-port-allocations target=_blank rel=noreferrer>specific port</a>.</p><p>Finally, another one of the great advantages of Prometheus, besides it is open source, is that it belongs to the <a href=https://www.cncf.io/ target=_blank rel=noreferrer>CNCF</a> ecosystem as <a href=https://www.cncf.io/announcement/2018/08/09/prometheus-graduates/ target=_blank rel=noreferrer>graduated project</a> for monitoring in cloud-native environments and works <a href=https://www.weave.works/blog/prometheus-kubernetes-perfect-match/ target=_blank rel=noreferrer>very good</a> in Kubernetes environments, so is becoming to a de-facto standard solution for monitoring distributed system. Also, the Prometheus <a href=https://prometheus.io/docs/instrumenting/exposition_formats/ target=_blank rel=noreferrer>exposition format</a> is evolving into an open standard: <a href=https://openmetrics.io/ target=_blank rel=noreferrer>OpenMetrics</a></p><p>You can read more about how Prometheus work <a href=https://prometheus.io/docs/introduction/overview/ target=_blank rel=noreferrer>here</a> and why important companies like Weavework <a href=https://www.weave.works/technologies/monitoring-kubernetes-with-prometheus/ target=_blank rel=noreferrer>choose</a> Prometheus as a monitoring system.</p><p>To install Prometheus you can use a <a href=https://github.com/helm/charts/tree/master/stable/prometheus target=_blank rel=noreferrer>Helm chart</a> or with the <a href=https://github.com/coreos/prometheus-operator target=_blank rel=noreferrer>Prometheus Operator</a> which seems the best option to deploy a Prometheus instance to Kubernetes.</p><h3 id=setting-up-a-django-application-to-work-with-prometheus class="relative group">Setting up a Django application to work with Prometheus <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#setting-up-a-django-application-to-work-with-prometheus aria-label=Anchor>#</a></span></h3><p>The following steps suppose that you have your application properly dockerized and prepared to run in Kubernetes environment. A few changes to the configuration of uWSGI, NGINX and Django are needed to provide a proper monitoring.</p><h4 id=enable-uwsgi-monitoring class="relative group">Enable uWSGI monitoring <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enable-uwsgi-monitoring aria-label=Anchor>#</a></span></h4><p>uWSGI provides by default a <a href=https://uwsgi-docs.readthedocs.io/en/latest/StatsServer.html target=_blank rel=noreferrer>stats module</a> which opens a port and expose metrics in JSON format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;workers&#34;</span>: [{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pid&#34;</span>: <span style=color:#ae81ff>31759</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;requests&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;exceptions&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;idle&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;rss&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;vsz&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;running_time&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;last_spawn&#34;</span>: <span style=color:#ae81ff>1317235041</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;respawn_count&#34;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;tx&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avg_rt&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;apps&#34;</span>: [{
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;modifier1&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;mountpoint&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;requests&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;exceptions&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;chdir&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    }]
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>This endpoint will be used by a Prometheus exporter to scrape and expose it in Prometheus format. We need to change the <code>uwsgi.ini</code> file to open the port:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a6e22e>stats</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>:1717</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>stats-http</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>true</span>
</span></span></code></pre></div><h4 id=enable-nginx-monitoring class="relative group">Enable NGINX monitoring <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enable-nginx-monitoring aria-label=Anchor>#</a></span></h4><p>Similar to uWSGI, NGINX provides a <a href=http://nginx.org/en/docs/http/ngx_http_stub_status_module.html target=_blank rel=noreferrer>stub status module</a> which provides a basic status information:</p><pre tabindex=0><code>Active connections: 291 
server accepts handled requests
 16630948 16630948 31070465 
Reading: 6 Writing: 179 Waiting: 106 
</code></pre><p>To enable this config, add these lines to your NGINX config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span> <span style=color:#e6db74>default_server</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>location</span> <span style=color:#e6db74>/nginx/status</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>stub_status</span> <span style=color:#66d9ef>on</span>;
</span></span><span style=display:flex><span>        <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you need more detailed metrics about NGINX you can use <a href=https://github.com/vozlt/nginx-module-vts target=_blank rel=noreferrer>NGINX virtual host traffic status module</a> instead.</p><h4 id=enable-django-monitoring class="relative group">Enable Django monitoring <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#enable-django-monitoring aria-label=Anchor>#</a></span></h4><p>This is the most important while monitoring our Django application. For that purpose, we will use <a href=https://github.com/korfuri/django-prometheus target=_blank rel=noreferrer>django-prometheus</a>. This library allows us to expose metrics that comes from the processing of incoming and outbound requests (like the total requests of a specific view) without adding to much code. If you need to instrument your application placing business logic metrics you can also use this library as includes the Python client for Prometheus.</p><p>To enable basic Prometheus monitoring with Django, follow these steps:</p><ul><li>Install the package: <code>pip install django-prometheus</code></li><li>Add the library to <code>INSTALLED_APPS</code> list in <code>settings.py</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    INSTALLED_APPS <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;django_prometheus&#39;</span>,
</span></span><span style=display:flex><span>    ]
</span></span></code></pre></div><ul><li>Add the required middlewares in <code>MIDDLEWARE</code> list in <code>settings.py</code>. The order is important so <code>PrometheusBeforeMiddleware</code> needs to be the first one in the list and <code>PrometheusAfterMiddleware</code> needs to be the last:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    MIDDLEWARE <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;django_prometheus.middleware.PrometheusBeforeMiddleware&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;django_prometheus.middleware.PrometheusAfterMiddleware&#39;</span>,
</span></span><span style=display:flex><span>    ]
</span></span></code></pre></div><ul><li>Add this url pattern in <code>urls.py</code>:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>  urlpatterns <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>     <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>     path(<span style=color:#e6db74>&#39;&#39;</span>, include(<span style=color:#e6db74>&#39;django_prometheus.urls&#39;</span>)),
</span></span><span style=display:flex><span>  ]
</span></span></code></pre></div><ul><li>Finally, it&rsquo;s recommended restrict the access the provided endpoint in <code>urls.py</code> to avoid to be public. We can disable it in the NGINX config:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>server</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>listen</span> <span style=color:#ae81ff>8000</span> <span style=color:#e6db74>default_server</span>;
</span></span><span style=display:flex><span>       <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>location</span> <span style=color:#e6db74>/metrics</span> {
</span></span><span style=display:flex><span>            <span style=color:#f92672>deny</span>  <span style=color:#e6db74>all</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>            <span style=color:#f92672>error_log</span> <span style=color:#66d9ef>off</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>   }
</span></span></code></pre></div><p>A common <a href=https://github.com/korfuri/django-prometheus/issues/34 target=_blank rel=noreferrer>issue</a> that happends running the <code>./manage.py collectstatic</code> command and it is not documented yet could be fixed adding this to the<code>settings.py</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>PROMETHEUS_EXPORT_MIGRATIONS <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span></code></pre></div><h3 id=setting-up-the-kubernetes-deployment class="relative group">Setting up the Kubernetes Deployment <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#setting-up-the-kubernetes-deployment aria-label=Anchor>#</a></span></h3><p>Once we have the new Docker images for the changes previously introduced it&rsquo;s time to modify our Kubernetes deployment as Prometheus should be able to gather all exposed metrics. For that purpose, we will use the above mentioned Prometheus exporters.</p><p>Thanks to the Prometheus community there are a lot of exporters for a lot of software projects. So we will use existing exporters for uWSGI and NGINX that will be added as <a href=https://kubernetes.io/blog/2015/06/the-distributed-system-toolkit-patterns/ target=_blank rel=noreferrer>sidecar containers</a> of our application deployment:</p><ul><li>uWSGI: <a href=https://github.com/timonwong/uwsgi_exporter target=_blank rel=noreferrer>https://github.com/timonwong/uwsgi_exporter</a></li><li>NGINX: <a href=https://github.com/discordianfish/nginx_exporter target=_blank rel=noreferrer>https://github.com/discordianfish/nginx_exporter</a>. But if you need more metrics your probably should use <a href=https://github.com/hnlq715/nginx-vts-exporter target=_blank rel=noreferrer>https://github.com/hnlq715/nginx-vts-exporter</a>.</li></ul><p>Hence, the result Deployment should look as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>extensions/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>mynamespace</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapp</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tier</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Recreate</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>prometheus.io/scrape</span>: <span style=color:#e6db74>&#39;true&#39;</span>    
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapp</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>tier</span>: <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>affinity</span>: {}
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># uwsgi exporter</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>stats.uri=http://localhost:1717</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>timonwong/uwsgi-exporter</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>uwsgi-exporter</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>10Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>25Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/-/healthy</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9117</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># nginx exporter</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>nginx.scrape_uri=http://localhost/nginx/status</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>fish/nginx-exporter</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-exporter</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>10Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>25M</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/-/healthy</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9113</span>
</span></span></code></pre></div><p>Since all containers in the Pod shares the same <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod/#resource-sharing-and-communication target=_blank rel=noreferrer>namespace network</a> the exposed endpoints of uWSGI and NGINX will be visible for each exporter.</p><p>Notice that we didn&rsquo;t specify anything for Django metrics as is by default exposed a <code>localhost:&lt;UWSGI_PORT>/metrics</code>.</p><p>Look that we used <code>prometheus.io/scrape: 'true'</code> tag. This enables <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#%3Ckubernetes_sd_config%3E target=_blank rel=noreferrer>Prometheus Kubernetes service discover</a> to find out which Deployments have metrics endpoints to scrape.</p><p>The problem doing this is that Prometheus will try to fetch <code>/metrics</code> and scrape all the open HTTP ports of all the containers of the tagged Deployment causing that the Prometheus scraper throws errors when trying to scrape HTTP servers that don&rsquo;t expose metrics (uWSGI, NGINX,&mldr;).</p><p>The solution is change the <code>prometheus.yaml</code> config file and add these lines to <code>scrape_configs</code> section:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;kubernetes-pods-containers&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>kubernetes_sd_configs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>role</span>: <span style=color:#ae81ff>pod</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>action</span>: <span style=color:#ae81ff>keep</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>regex</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__meta_kubernetes_pod_annotation_prometheus_io_path]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__metrics_path__</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>(.+)</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>action</span>: <span style=color:#ae81ff>replace</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>([^:]+)(?::\d+)?;(\d+)</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>replacement</span>: <span style=color:#ae81ff>$1:$2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>target_label</span>: <span style=color:#ae81ff>__address__</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>source_labels</span>: [<span style=color:#ae81ff>__meta_kubernetes_pod_container_port_name]</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>action</span>: <span style=color:#ae81ff>keep                    </span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>regex</span>: <span style=color:#ae81ff>metrics </span>
</span></span></code></pre></div><p>The lines above will config Prometheus to scrape only those endpoints of containers of the Deployment that have an explicit <code>port</code> section in its specification:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      - <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>stats.uri=http://localhost:1717</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>timonwong/uwsgi-exporter</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>uwsgi-exporter</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>10m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>10Mi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>limits</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>cpu</span>: <span style=color:#ae81ff>100m</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>memory</span>: <span style=color:#ae81ff>25Mi</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>livenessProbe</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>httpGet</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/-/healthy</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9117</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;metrics&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9117</span>
</span></span></code></pre></div><p>Now we have our Django application fully monitored with Prometheus. Is also highly recommended to monitor all the external services and external backends such as databases, cache systems, load balancers, etc.</p><h3 id=integration-with-stackdriver class="relative group">Integration with Stackdriver <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#integration-with-stackdriver aria-label=Anchor>#</a></span></h3><p>It is possible to have a Prometheus installed in your cluster and at the same time send your metrics to <a href=https://cloud.google.com/stackdriver/ target=_blank rel=noreferrer>Stackdriver</a> which is an excellent option if you use Kubernetes under Google Cloud. Just follow <a href=https://cloud.google.com/monitoring/kubernetes-engine/prometheus target=_blank rel=noreferrer>this steps</a> without changing anything of the explained before.</p><h4 id=alternative-option class="relative group">Alternative option <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#alternative-option aria-label=Anchor>#</a></span></h4><p>An alternative way is instead of to deploy a full Prometheus installation you can just put a special side-car container with an image of <a href=https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/prometheus-to-sd target=_blank rel=noreferrer>prometheus-to-sd</a> which is a little piece of software that translates the metrics of your Prometheus exporters and send it to Stackdriver. You just need to add this container to your Deployment:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>prometheus-to-sd</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gcr.io/google-containers/prometheus-to-sd:latest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>command</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>/monitor</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>source=:http://localhost:9117/metrics</span> <span style=color:#75715e># uwsgi</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>source=:http://localhost:9113/metrics</span> <span style=color:#75715e># nginx</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>source=:http://localhost:8080/metrics</span> <span style=color:#75715e># django</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>stackdriver-prefix=custom.googleapis.com</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>pod-id=$(POD_ID)</span>
</span></span><span style=display:flex><span>        - --<span style=color:#ae81ff>namespace-id=$(POD_NAMESPACE)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>POD_ID</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>fieldRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>fieldPath</span>: <span style=color:#ae81ff>metadata.name</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>POD_NAMESPACE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>valueFrom</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>fieldRef</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>fieldPath</span>: <span style=color:#ae81ff>metadata.namespace    </span>
</span></span></code></pre></div><p>You need to add a line with <code>--source=:</code> and the path for every exporter that you want to collect the metrics.</p><p>You have to keep in mind that both solutions are <strong>experimental</strong>. There also some <a href=https://github.com/Stackdriver/stackdriver-prometheus/issues/15 target=_blank rel=noreferrer>discussions</a> of which solution is better.</p><h3 id=example-usage-of-a-real-app class="relative group">Example usage of a real app <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#example-usage-of-a-real-app aria-label=Anchor>#</a></span></h3><p>It is interesting to show some of the most important metrics of each exporter that could be useful to use to monitoring and alerting. If you are not familiar with Prometheus exporting format this will be interesting for you too.</p><h4 id=nginx-metrics class="relative group">NGINX metrics <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#nginx-metrics aria-label=Anchor>#</a></span></h4><ul><li>Average response time (milliseconds):</li></ul><pre tabindex=0><code># HELP http_request_duration_microseconds The HTTP request latencies in microseconds.
# TYPE http_request_duration_microseconds summary
http_request_duration_microseconds{handler=&#34;prometheus&#34;,quantile=&#34;0.5&#34;} 2769.075
http_request_duration_microseconds{handler=&#34;prometheus&#34;,quantile=&#34;0.9&#34;} 3520.802
http_request_duration_microseconds{handler=&#34;prometheus&#34;,quantile=&#34;0.99&#34;} 8228.981
http_request_duration_microseconds_sum{handler=&#34;prometheus&#34;} 1.5934673549999993e+06
http_request_duration_microseconds_count{handler=&#34;prometheus&#34;} 408
</code></pre><ul><li>Connections processed by NGINX:</li></ul><pre tabindex=0><code># HELP nginx_connections_current Number of connections currently processed by nginx
# TYPE nginx_connections_current gauge
nginx_connections_current{state=&#34;active&#34;} 1
nginx_connections_current{state=&#34;reading&#34;} 0
nginx_connections_current{state=&#34;waiting&#34;} 0
nginx_connections_current{state=&#34;writing&#34;} 1
</code></pre><h4 id=uwsgi-metrics class="relative group">uWSGI metrics <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#uwsgi-metrics aria-label=Anchor>#</a></span></h4><p>Metrics that could be obtained of each running uWSGI worker.</p><ul><li>Transmited bytes:</li></ul><pre tabindex=0><code># HELP uwsgi_worker_transmitted_bytes_total Worker transmitted bytes.
# TYPE uwsgi_worker_transmitted_bytes_total counter
uwsgi_worker_transmitted_bytes_total{stats_uri=&#34;http://localhost:1717&#34;,worker_id=&#34;1&#34;} 2.0374868e+07
</code></pre><ul><li>Average response time (in seconds):</li></ul><pre tabindex=0><code># HELP uwsgi_worker_average_response_time_seconds Average response time in seconds.
# TYPE uwsgi_worker_average_response_time_seconds gauge
uwsgi_worker_average_response_time_seconds{stats_uri=&#34;http://localhost:1717&#34;,worker_id=&#34;1&#34;} 0.093864
</code></pre><ul><li>Harakiri count:</li></ul><pre tabindex=0><code># HELP uwsgi_worker_harakiri_count_total Total number of harakiri count.
# TYPE uwsgi_worker_harakiri_count_total counter
uwsgi_worker_harakiri_count_total{stats_uri=&#34;http://localhost:1717&#34;,worker_id=&#34;1&#34;} 0
</code></pre><h4 id=django-metrics class="relative group">Django metrics <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#django-metrics aria-label=Anchor>#</a></span></h4><p>Metrics exposed from the middlewares of Prometheus Django package.</p><ul><li>Response by status code:</li></ul><pre tabindex=0><code># HELP django_http_responses_total_by_status Count of responses by status.
# TYPE django_http_responses_total_by_status counter
django_http_responses_total_by_status{status=&#34;200&#34;} 630.0
django_http_responses_total_by_status{status=&#34;404&#34;} 103.0
django_http_responses_total_by_status{status=&#34;301&#34;} 3.0
</code></pre><ul><li>Total number of requests by view:</li></ul><pre tabindex=0><code># HELP django_http_requests_total_by_view_transport_method Count of requests by view, transport, method.
# TYPE django_http_requests_total_by_view_transport_method counter
django_http_requests_total_by_view_transport_method{method=&#34;POST&#34;,transport=&#34;https&#34;,view=&#34;product:add-to-cart&#34;} 4.0
django_http_requests_total_by_view_transport_method{method=&#34;GET&#34;,transport=&#34;https&#34;,view=&#34;cart:cart-summary&#34;} 67.0
</code></pre><ul><li>Histogram of latencies by view:</li></ul><pre tabindex=0><code># HELP django_http_requests_latency_seconds_by_view_method Histogram of request processing time labelled by view.
# TYPE django_http_requests_latency_seconds_by_view_method histogram
django_http_requests_latency_seconds_by_view_method_bucket{le=&#34;0.005&#34;,method=&#34;GET&#34;,view=&#34;cart:cart-summary&#34;} 0.0
...
django_http_requests_latency_seconds_by_view_method_bucket{le=&#34;0.5&#34;,method=&#34;GET&#34;,view=&#34;cart:cart-summary&#34;} 67.0
django_http_requests_latency_seconds_by_view_method_bucket{le=&#34;0.75&#34;,method=&#34;GET&#34;,view=&#34;cart:cart-summary&#34;} 67.0
django_http_requests_latency_seconds_by_view_method_bucket{le=&#34;1.0&#34;,method=&#34;GET&#34;,view=&#34;cart:cart-summary&#34;} 67.0
...
django_http_requests_latency_seconds_by_view_method_bucket{le=&#34;+Inf&#34;,method=&#34;GET&#34;,view=&#34;cart:cart-summary&#34;} 67.0
</code></pre><h3 id=conclusions class="relative group">Conclusions <span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusions aria-label=Anchor>#</a></span></h3><p>It may seem that follow these guidelines will cost you a lot of work and those metrics are only a few that are provided by default, so you <strong>should</strong> instrument your application setting the proper metrics according to your business requirements. That&rsquo;s the real effort: change your mind and do this job from the beginning.</p><p>The robustness and simplicity of Prometheus is a game changer in the world of monitoring applications and it could save a lot of time and money of operational tasks if you use it properly.</p></div></section><footer class="max-w-prose pt-8 print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="group flex" href=/posts/new-site/><span class="me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span><span class="ltr:hidden rtl:inline">&rarr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">New site with Hugo</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2018-07-01 00:00:00 +0000 UTC">1 July 2018</time>
</span></span></a></span><span><a class="group flex text-right" href=/posts/vas/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Service Architecture - Value-Added Services</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2021-08-20 00:00:00 +0000 UTC">20 August 2021</time>
</span></span><span class="ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[-2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&rarr;</span><span class="ltr:hidden rtl:inline">&larr;</span></span></a></span></div></div></footer></article></main><div class="pointer-events-none absolute bottom-0 end-0 top-[100vh] w-12" id=to-top hidden=true><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div><footer class="py-10 print:hidden"><nav class="pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex list-none flex-col sm:flex-row"><li class="group mb-1 text-end sm:mb-0 sm:me-7 sm:last:me-0"><a href title><span class="decoration-primary-500 group-hover:underline group-hover:decoration-2 group-hover:underline-offset-2"></span></a></li></ul></nav><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Marc Tudurí</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://github.com/jpanther/congo target=_blank rel="noopener noreferrer">Congo</a></p></div><div class="flex flex-row items-center"><div class="me-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher-0 type=button aria-label="appearance switcher"><div class="flex h-12 w-12 items-center justify-center dark:hidden" title="Switch to dark appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden h-12 w-12 items-center justify-center dark:flex" title="Switch to light appearance"><span class="icon relative inline-block px-1 align-text-bottom"><svg viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div></div></footer></div></body></html>